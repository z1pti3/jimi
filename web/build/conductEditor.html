{% extends "main.html" %}

{% block head %}
    {{ jimi.jquery() }}
	<script src="{{ url_for('static', filename='includes/select2/select2.min.js') }}"></script>
	<link rel="stylesheet" href="{{ url_for('static', filename='includes/select2/select2.min.css') }}">
	{{ jimi.visjs() }}
	<script src="{{ url_for('static', filename='javascript/flow.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/objectProperties.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/linkProperties.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/newObject.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/alert.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/existingObject.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/triggerObject.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/aclProperties.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/objectSystemSettings.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/objectRevisionHistory.js') }}"></script>
	<script src="{{ url_for('static', filename='javascript/triggerSnapshotHistory.js') }}"></script>

	<script src="{{ url_for('static', filename='javascript/hotkeys.js') }}"></script>

	<link rel="stylesheet" href="{{ url_for('static', filename='css/conductEditor.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/objectProperties.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/alert.css') }}">

	<link rel="stylesheet" href="{{ url_for('static', filename='themes/default/default.css') }}">
{% endblock %}

{% block head2 %}
	{{ jimi.monaco() }}
{% endblock %}

{% block body %}
	<div class="h-100 w-100">
		<div class="conductEditor-topBar" style="display: table; width: 100%;" >
			<div style="display: table-cell;">
				<h2 style="right: 0; display: inline; position: relative;">{{ conductName }}</h2>
				<br><i style="right: 0; display: inline; position: relative;">Users in this conduct: <span id="activeUsers"></span></i>
			</div>
			<div style="display: table-cell; vertical-align: middle; height: 100%;" class="d-flex justify-content-end">
				<button onclick="openSidebar()" class="btn btn-primary topBarButton button">+</button>
				<button onclick="debugConduct()" class="btn btn-primary topBarButton button bi-bug"> Debug</button>
				<button onclick="exportConduct()" class="btn btn-primary topBarButton button bi-box-arrow-in-down-right"> Export</button>
				<button onclick="importConduct()" class="btn btn-primary topBarButton button bi-box-arrow-in-up-left"> Import</button>
				<button class="btn btn-primary topBarButton button bi-binoculars" data-bs-toggle="modal" data-bs-target="#conductSearch"> Find</button>
			</div>
		</div>
		<div class="ui-main">
			<!-- Right Click Menus -->
			<ul id="contextMenu" class="dropdown-menu contextMenuTrigger" role="menu" style="display:none;" >
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editFlowObject()">Edit</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="copyFlowObject()">Clone ( as linked copy )</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="exportFlowObject()">Export</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="triggerSanpshotHistory()">Execution Snapshots</a></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="loadTriggerStatistics()">Statistics</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editObjectSystemSettings()">System Settings</a></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editWithinModelEditor()">Edit with Model Editor</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editACL()">Security Settings</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="objectRevisionHistory()">Revision History</a></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="deleteFlowObject()">Delete</a></li>
			</ul>
			<ul id="contextMenu" class="dropdown-menu contextMenuAction" role="menu" style="display:none" >
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editFlowObject()">Edit</a></li>
				<li id="connectFlowObject"><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="connectFlowObject()">Connect Flow</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="copyFlowObject()">Clone ( as linked copy )</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editObjectSystemSettings()">System Settings</a></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editWithinModelEditor()">Edit with Model Editor</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="editACL()">Security Settings</a></li>
				<li class="divider theme-dropdown-menu-divider"></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="objectRevisionHistory()">Revision History</a></li>
				<li><a tabindex="-1" class="noHover hoverHand" style="display: block;" onclick="deleteFlowObject()">Delete</a></li>
			</ul>
			<div class="flowchart theme-content" id="flowchart"></div>
			<div class="flowchart-sidebar hide">
				<div class="flowchart-sidebar-header">
					<a class="noHover hoverHand" onclick="closeSidebar()" >X</a>
				</div>
				<div class="form-floating">
					<input type="input" class="form-control textbox" id="search" autoComplete="off" placeholder="Theme" value="{{ search }}">
					<label for="search" class="bi-chat-text"> Search</label>
				</div>
				<ul class="nav nav-tabs">
					<li class="nav-item">
						<a class="nav-link active" id="all-tab" href="#" data-bs-toggle="tab" data-bs-target="#all" role="tab" aria-controls="access" aria-selected="false">All</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="triggers-tab" href="#" data-bs-toggle="tab" data-bs-target="#triggers" role="tab" aria-controls="access" aria-selected="false">Triggers</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="actions-tab" href="#" data-bs-toggle="tab" data-bs-target="#actions" role="tab" aria-controls="access" aria-selected="false">Actions</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="existing-tab" href="#" data-bs-toggle="tab" data-bs-target="#existing" role="tab" aria-controls="access" aria-selected="false">Existing</a>
					</li>
				</ul>
				<div class="tab-content text-left" id="myTabContent">
					<div class="tab-pane show active" id="all" role="tabpanel" aria-labelledby="all-tab">
						All
					</div>
					<div class="tab-pane" id="triggers" role="tabpanel" aria-labelledby="triggers-tab">
						Triggers
					</div>
					<div class="tab-pane" id="actions" role="tabpanel" aria-labelledby="actions-tab">
						Actions
					</div>
					<div class="tab-pane" id="existing" role="tabpanel" aria-labelledby="existing-tab">
						Existing
					</div>
				</div>
			</div>
			<div class="modal fade" id="conductSearch" tabindex="-1" role="dialog" aria-labelledby="Conduct Search" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered modal-dialog-search" role="document">
					<div class="modal-content panel">
						<div class="modal-body">
							<div class="input-group">
								<div class="form-floating" style="min-width: 100%;">
									<input type="search" class="form-control textbox" id="searchInputConduct" autofocus placeholder="search" value="">
									<label for="searchInput">Search</label>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		var CSRF = "{{CSRF}}"
	</script>

	<!-- Right Click Menu -->
	<script>
		(function ($, window) {
			$.fn.contextMenu = function (settings) {
				return this.each(function () {
					$(this).on("contextmenu", function (e) {
						return false
					});
					//make sure menu closes on any click
					$('body').click(function () {
						$(".contextMenuTrigger").hide();
						$(".contextMenuAction").hide();
					});
				});
		};
		})(jQuery, window);
		$("#flowchart").contextMenu({menuSelector: "#contextMenu" });

		$(document).ready(function () {
                $(window).bind("keydown", function (event) { 
                    if (event.ctrlKey || event.metaKey) {
                        if (event.keyCode == 70 & typeof(document.activeElement["attributes"]["tag"]) == "undefined") {
							event.preventDefault();
                            $('#conductSearch').modal('show');
							document.getElementById("searchInputConduct").focus();
							document.getElementById("searchInputConduct").select();
                        }
                    }
                })
            });

		// Handles searching on enter
		var input = document.getElementById("searchInputConduct");
		input.addEventListener("keyup", function(event) {
		// Number 13 is the "Enter" key on the keyboard
		if (event.keyCode === 13) {
			event.preventDefault();
			findConductObject();
			$("#conductSearch").modal("hide");
			document.getElementById("searchInputConduct").value="";
		}
		});

		function closeSidebar() {
			$('.flowchart-sidebar').addClass('hide')
		}

		function openSidebar() {
			$('.flowchart-sidebar').removeClass('hide')
		}

		function findConductObject() {
			$.ajax({ url: "/searchConduct", type : "GET",  data:{query: $("#searchInputConduct").val(),conductID: GetURLParameter("conductID")}, contentType:"application/json", 
                success: function ( result ) 
                {
					console.log(result["objects"]);
					network.selectNodes(result["objects"]);
					network.focus(result["objects"][0],{scale:2});
                }
            });
			
		}
	</script>
{% endblock %}